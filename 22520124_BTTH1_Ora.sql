-- Tạo bảng CONGTY
CREATE TABLE CONGTY (
    MaCongTy CHAR(5) PRIMARY KEY,
    TenCty VARCHAR2(40),
    LinhVuc VARCHAR2(40),
    SoLuongTV NUMBER,
    HangCongTy VARCHAR2(40)
);

-- Tạo bảng NGUOITHIDAU
CREATE TABLE NGUOITHIDAU (
    CCCD VARCHAR2(12) PRIMARY KEY,
    HoTen VARCHAR2(40),
    GioiTinh VARCHAR2(3),
    NgaySinh DATE,
    ThanhTich NVARCHAR2(255),
    MaCongTy CHAR(5),
    CONSTRAINT FK_MaCongTy FOREIGN KEY (MaCongTy) REFERENCES CONGTY(MaCongTy)
);

-- Tạo bảng GIAITHIDAU
CREATE TABLE GIAITHIDAU (
    MaGiai CHAR(5) PRIMARY KEY,
    TenGiai VARCHAR2(40),
    NgayToChuc TIMESTAMP,
    DiaDiem VARCHAR2(40)
);

-- Tạo bảng NOIDUNGTHI
CREATE TABLE NOIDUNGTHI (
    MaNoiDung CHAR(5) PRIMARY KEY,
    TenND VARCHAR2(40),
    BatDau TIMESTAMP,
    KetThuc TIMESTAMP,
    QDuong NUMBER,
    ChiPhi NUMBER,
    MaGiai CHAR(5),
    CONSTRAINT FK_MaGiai FOREIGN KEY (MaGiai) REFERENCES GIAITHIDAU(MaGiai)
);

-- Tạo bảng DANGKY
CREATE TABLE DANGKY (
    MaNoiDung CHAR(5),
    CCCD VARCHAR2(12),
    NgayDangKy TIMESTAMP,
    KetQuaDatDuoc VARCHAR2(40),
    HuyChuong VARCHAR2(40),
    ThGianHT TIMESTAMP,
    Gia NUMBER,
    PRIMARY KEY (MaNoiDung, CCCD),
    CONSTRAINT FK_MaNoiDung FOREIGN KEY (MaNoiDung) REFERENCES NOIDUNGTHI(MaNoiDung),
    CONSTRAINT FK_CCCD FOREIGN KEY (CCCD) REFERENCES NGUOITHIDAU(CCCD)
);

-- Chèn dữ liệu cho bảng CONGTY
INSERT INTO CONGTY (MaCongTy, TenCty, LinhVuc, SoLuongTV, HangCongTy)
VALUES('CT001', 'VNG', 'Cong Nghe Thong Tin', 1000, 'Silver');
INSERT INTO CONGTY (MaCongTy, TenCty, LinhVuc, SoLuongTV, HangCongTy)
VALUES('CT002', 'Vinamilk', 'Thuc Pham Thiet Yeu', 1100, 'Silver');
INSERT INTO CONGTY (MaCongTy, TenCty, LinhVuc, SoLuongTV, HangCongTy)
VALUES ('CT003', 'Mitsubisi', 'Dien May', 5000, 'Diamond');

-- Chèn dữ liệu cho bảng NGUOITHIDAU
INSERT INTO NGUOITHIDAU (CCCD, HoTen, GioiTinh, NgaySinh, ThanhTich, MaCongTy)
VALUES
('CCCD001', 'Nguyễn Văn A', 'Nam', TO_DATE('1990-01-01', 'YYYY-MM-DD'), 'Thành Tích A', 'CT001');
INSERT INTO NGUOITHIDAU (CCCD, HoTen, GioiTinh, NgaySinh, ThanhTich, MaCongTy)
VALUES
('CCCD002', 'Trần Thị B', 'Nu', TO_DATE('1985-03-15', 'YYYY-MM-DD'), 'Thành Tích B', 'CT002');
INSERT INTO NGUOITHIDAU (CCCD, HoTen, GioiTinh, NgaySinh, ThanhTich, MaCongTy)
VALUES
('CCCD003', 'Lê Văn C', 'Nam', TO_DATE('1995-05-20', 'YYYY-MM-DD'), 'Thành Tích C', 'CT003');

-- Chèn dữ liệu cho bảng GIAITHIDAU
INSERT INTO GIAITHIDAU (MaGiai, TenGiai, NgayToChuc, DiaDiem)
VALUES
('G001', 'Giải A', TO_TIMESTAMP('2023-05-01 10:00:00', 'YYYY-MM-DD HH24:MI:SS'), 'Địa Điểm A');
INSERT INTO GIAITHIDAU (MaGiai, TenGiai, NgayToChuc, DiaDiem)
VALUES
('G002', 'Giải B', TO_TIMESTAMP('2023-06-01 11:30:00', 'YYYY-MM-DD HH24:MI:SS'), 'Địa Điểm B');
INSERT INTO GIAITHIDAU (MaGiai, TenGiai, NgayToChuc, DiaDiem)
VALUES
('G003', 'Giải C', TO_TIMESTAMP('2023-07-01 14:00:00', 'YYYY-MM-DD HH24:MI:SS'), 'Địa Điểm C');


-- Chèn dữ liệu cho bảng NOIDUNGTHI
INSERT INTO NOIDUNGTHI (MaNoiDung, TenND, BatDau, KetThuc, QDuong, ChiPhi, MaGiai)
VALUES
('ND001', 'Nội Dung A', TO_TIMESTAMP('2023-05-01 10:00:00', 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP('2023-05-01 12:00:00', 'YYYY-MM-DD HH24:MI:SS'), 100, 500.00, 'G001');
INSERT INTO NOIDUNGTHI (MaNoiDung, TenND, BatDau, KetThuc, QDuong, ChiPhi, MaGiai)
VALUES
('ND002', 'Nội Dung B', TO_TIMESTAMP('2023-05-01 13:00:00', 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP('2023-05-01 15:00:00', 'YYYY-MM-DD HH24:MI:SS'), 150, 700.00, 'G001');
INSERT INTO NOIDUNGTHI (MaNoiDung, TenND, BatDau, KetThuc, QDuong, ChiPhi, MaGiai)
VALUES
('ND003', 'Nội Dung C', TO_TIMESTAMP('2023-06-01 09:30:00', 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP('2023-06-01 11:30:00', 'YYYY-MM-DD HH24:MI:SS'), 120, 600.00, 'G002');
-- Thêm dữ liệu cho 17 dòng khác

-- Chèn dữ liệu cho bảng DANGKY
INSERT INTO DANGKY (MaNoiDung, CCCD, NgayDangKy, KetQuaDatDuoc, HuyChuong, ThGianHT, Gia)
VALUES
('ND001', 'CCCD001', TO_TIMESTAMP('2023-04-20 08:30:00', 'YYYY-MM-DD HH24:MI:SS'), 'Đạt', 'Huy Chương A', TO_TIMESTAMP('2023-05-01 11:30:00', 'YYYY-MM-DD HH24:MI:SS'), 200.00);
INSERT INTO DANGKY (MaNoiDung, CCCD, NgayDangKy, KetQuaDatDuoc, HuyChuong, ThGianHT, Gia)
VALUES
('ND002', 'CCCD002', TO_TIMESTAMP('2023-04-25 09:00:00', 'YYYY-MM-DD HH24:MI:SS'), 'Đạt', 'Huy Chương B', TO_TIMESTAMP('2023-05-01 14:30:00', 'YYYY-MM-DD HH24:MI:SS'), 250.00);
INSERT INTO DANGKY (MaNoiDung, CCCD, NgayDangKy, KetQuaDatDuoc, HuyChuong, ThGianHT, Gia)
VALUES
('ND003', 'CCCD003', TO_TIMESTAMP('2023-05-28 14:00:00', 'YYYY-MM-DD HH24:MI:SS'), 'Đạt', 'Huy Chương C', TO_TIMESTAMP('2023-06-01 10:00:00', 'YYYY-MM-DD HH24:MI:SS'), 180.00);


SELECT * FROM CONGTY c

-- 2.a
SELECT MACONGTY, TENCTY FROM CONGTY
WHERE HANGCONGTY = 'Diamond' AND SOLUONGTV >= 150;

-- 2.b
SELECT NTD.CCCD, NTD.HOTEN FROM NGUOITHIDAU NTD, DANGKY DK, NOIDUNGTHI NDT, GIAITHIDAU GTD
WHERE NTD.CCCD = DK.CCCD AND DK.MANOIDUNG = NDT.MANOIDUNG AND NDT.MAGIAI = GTD.MAGIAI AND NDT.TENND = 'Marathon 100m' AND GTD.TENGIAI = 'New Zelean 2023';

-- 2.c
SELECT CT.MACONGTY, CT.TENCTY, COUNT(NTD.CCCD) SL_NGTHIDAU FROM CONGTY CT, NGUOITHIDAU NTD, DANGKY DK, NOIDUNGTHI NDT, GIAITHIDAU GTD
WHERE CT.MACONGTY = NTD.MACONGTY AND NTD.CCCD = DK.CCCD AND DK.MANOIDUNG = NDT.MANOIDUNG AND NDT.MAGIAI = GTD.MAGIAI AND GTD.TENGIAI = 'Happy Hoppo 2024'
GROUP BY CT.MACONGTY, CT.TENCTY;

-- 2.d
SELECT NTD.CCCD, NTD.HOTEN FROM NGUOITHIDAU NTD
WHERE EXISTS(
  -- tìm người thi đấu ko đăng ký 2 năm liên tiếp
  SELECT CCCD FROM DANGKY
    WHERE CCCD = NTD.CCCD
    GROUP BY CCCD
    HAVING 
        EXTRACT(YEAR FROM MAX(NGAYDANGKY)) + 2 <= EXTRACT(YEAR FROM (SELECT MAX(NGAYTOCHUC) FROM GIAITHIDAU))  
        OR 
        EXTRACT(YEAR FROM MIN(NGAYDANGKY)) - 2 >= EXTRACT(YEAR FROM (SELECT MIN(NGAYTOCHUC) FROM GIAITHIDAU)) 
      -- so sánh 2 biên (đầu và cuối)
  UNION
  SELECT DK1.CCCD FROM DANGKY DK1
    WHERE DK1.CCCD = NTD.CCCD AND 0 = (
      SELECT COUNT(*) FROM DANGKY DK2
      WHERE 
        DK2.CCCD = DK1.CCCD 
        AND 
        EXTRACT(YEAR FROM DK1.NGAYDANGKY) + 2 <= EXTRACT(YEAR FROM (SELECT MAX(NGAYTOCHUC) FROM GIAITHIDAU))
        AND 
        (
          EXTRACT(YEAR FROM DK2.NGAYDANGKY) = EXTRACT(YEAR FROM DK1.NGAYDANGKY) + 1 
          OR 
          EXTRACT(YEAR FROM DK2.NGAYDANGKY) = EXTRACT(YEAR FROM DK1.NGAYDANGKY) + 2 
        )
      )
);

-- 2.e
SELECT CT.MACONGTY FROM CONGTY CT, NGUOITHIDAU NTD, DANGKY DK, NOIDUNGTHI NDT, GIAITHIDAU GTD
WHERE 
  CT.MACONGTY = NTD.MACONGTY AND NTD.CCCD = DK.CCCD AND DK.MANOIDUNG = NDT.MANOIDUNG AND NDT.MAGIAI = GTD.MAGIAI
  AND
  NDT.QDUONG = 5000 AND GTD.DIADIEM = 'Binh Duong'
GROUP BY CT.MACONGTY
HAVING COUNT(DISTINCT NDT.MANOIDUNG) = (
     SELECT COUNT(NDT1.MANOIDUNG) FROM NOIDUNGTHI NDT1, GIAITHIDAU GTD1
     WHERE NDT1.MAGIAI = GTD1.MAGIAI AND NDT1.QDUONG = 5000 AND GTD1.DIADIEM = 'Binh Duong'
     );

-- 2.f
SELECT MANOIDUNG NOIDUNG_DK_NHIEUNHAT FROM DANGKY
WHERE EXTRACT(YEAR FROM NGAYDANGKY) = 2023
GROUP BY MANOIDUNG
HAVING COUNT(CCCD) = (
  SELECT MAX(COUNT(DK.CCCD)) FROM DANGKY DK
  WHERE EXTRACT(YEAR FROM DK.NGAYDANGKY) = 2023
  GROUP BY DK.MANOIDUNG
  );